<!DOCTYPE HTML>
<html>
<head>
<title>NielsenCombined player test</title>
<script type="text/javascript" src="../../../tests/qunit/qunit-bootstrap.js"></script>
<script type="text/javascript" src="../../../mwEmbedLoader.php"></script>
<script type="text/javascript" src="../../../docs/js/doc-bootstrap.js"></script>
<script type="text/javascript">	

function jsKalturaPlayerTest( videoId ){
	
	// Name this module
	module( "NielsenCombined player" );

	var $iframe = $('#' + videoId + '_ifp').contents();
	var iframeContext = window.frames['kaltura_player_ifp'];
	var player =  $('#' + videoId )[0];
	
	asyncTest("Player Ready", function(){
		kalturaQunitWaitForPlayer(function(){
			ok( $iframe.find('.play-btn-large').length, ".play-btn-large found" );
			testPlay();
			start();
		});
	});
	// Playback 15 test
	window['testPlay'] = function(){
		asyncTest("Playback 15", function(){
			var playBeaconSent = false;
			// look for play becaon:
			$( player ).bind( 'NielsenCombined_DispatchEvent.play', function( event, args ){
				if( playBeaconSent ){
					ok( false, "Error play beacon sent twice");
				}
				playBeaconSent = true;
				equal( args[0], 15, "15 play argument" );
				equal( args[2], "content", "passed content type" );
				$( player ).unbind( 'NielsenCombined_DispatchEvent.play' );
				
				// Test pause after 3 seconds of play
				setTimeout( function(){  
					testPause();
					start();
				}, 3000 );
			});
			player.sendNotification( 'doPlay' );
			// Add a timeout for the play test
			setTimeout( function(){
				if( !playBeaconSent ){
					ok(false, "Play beacon never sent");
				}
				start();
			}, 4000 )
		})
	};
	window['testPause'] = function(){
		asyncTest("Pause 6, Resume 5 test", function(){
			var pauseTime = null;
			var pauseBeaconSent = false;
			$( player ).bind( 'NielsenCombined_DispatchEvent.pause', function( event, args ){
				pauseBeaconSent = true;
				equal( args[0], 6, "6 pause argument" );
				pauseTime =  args[1];
				equal( args[2], "content", "pause event has content" );
				$( player ).unbind( 'NielsenCombined_DispatchEvent.pause' );
				
				// Check for resume playback: 
				$( player ).bind( 'NielsenCombined_DispatchEvent.resume', function( event, args){
					equal( args[0], 5, "5 resume playback" );
					equal( args[1], pauseTime, "Pause Time In Sync" );
					equal( args[2], "content", "Resume with content argument"  );
					// remove resume binding. 
					$( player ).unbind( 'NielsenCombined_DispatchEvent.resume');
					// continue with seek test: 
					testSeek();
				});
				// resume playback
				player.sendNotification( 'doPlay' );
				
			});
			player.sendNotification( 'doPause' );
			setTimeout( function(){
				if( !pauseBeaconSent ){
					ok(false, "Pause beacon never sent");
				}
				start();
			}, 1000 )
		});
	};

	window['testSeek'] =function(){
		asyncTest("Seek  8 test", function(){
			$( player ).bind( 'NielsenCombined_DispatchEvent.seek', function( event, args ){
				equal( args[0], 8, "8 seek argument" );
				equal( Math.floor( args[2] ), 15, "Seek target time is 15 seconds" );
				equal( args[3], "content", "Seek includes content type" );
				$( player ).unbind( 'NielsenCombined_DispatchEvent.seek');
				// stop playback 
				player.sendNotification( 'doPause' );
				start();
			});
			// seek to 15 seconds: 
			player.sendNotification( 'doSeek', 15 );
		});
	};

	
}
</script>
<script type="text/javascript">	
var kdpPlayer = null;
kWidget.addReadyCallback( function( playerId ){
	kdpPlayer = $('#' + playerId )[0];
	// only html5 ( should change to a jsListener if we get the flash verison on this page as well)
	$( kdpPlayer ).bind( 'NielsenCombined_DispatchEvent', function( event, args ){
		$('#analyticsLog').append( "NielsenCombined:: " + JSON.stringify( args ) + "\n");
	});
});
</script>
<!-- qunit-kaltura must come after qunit-bootstrap.js and after mwEmbedLoader.php and after any jsCallbackReady stuff-->
<script type="text/javascript" src="../../KalturaSupport/tests/resources/qunit-kaltura-bootstrap.js"></script>
</head>
<body>
<h2> Nielsen Combined</h2>
<div id="nielsenAnalyticsSettings"></div>
<div id="playbackModeSelector"></div>
<br />

<div id="analyticsContainer" style="float:left;padding-right:20px;" >
	<i>Analytics events:</i> ( only html5 )<br />
	<textarea id="analyticsLog" rows='15' ></textarea>
	</div>
	<div id="kaltura_player" style="float:left;width:400px;height:330px"></div>

	<script>
	window['trackEvent'] = function( eventObj ){
		if( kdpPlayer ){
			$( kdpPlayer ).trigger( 'NielsenCombined_DispatchEvent',  [eventObj]);
		}
	}
	
	var flashvars = {
			'nielsenCombined':{
				'plugin': true,
				'position': "before",
				'relativeTo': "video",				
				'trackEventMonitor' : 'trackEvent',
				'clientId':"us-502202", 
				'vcid':"c15",
				'tag_title':"{mediaProxy.entry.name}",
				'tag_category' : "{mediaProxy.entry.categories}",
				'tag_subcategory' : "{mediaProxy.entryMetadata.subcategories}",
				'tag_censuscategory' : "{mediaProxy.entry.censuscategories}",
				'tag_imgurl' : "{mediaProxy.entry.thumbnailUrl}"
			}
		};
	
	function doEmbedPlayer( fv ){
		// clear the text box: 
		$('#analyticsLog').empty();
		kWidget.embed({
			'targetId' : 'kaltura_player',
			'wid' : '_243342',
			'uiconf_id' : '11138511',
			'entry_id' : '0_swup5zao',
			'flashvars': fv
		})
	}
	/* embed with flashvars: */
	doEmbedPlayer(flashvars);
		
	$( '#nielsenAnalyticsSettings' ).prettyKalturaConfig(
			'nielsenCombined', 
			flashvars, 
			function(fv){
				doEmbedPlayer( fv );
			}
	);
	analyticsLog
	
	</script>

<!--  uiConf used in above test: 

<layout id="full" name="NielsenCombined Test Player" skinPath="/content/uiconf/kaltura/kmc/appstudio/kdp3/eagle/skin/v3.5.9/skin.swf">
  <HBox id="topLevel" width="100%" height="100%">
    <VBox id="player" width="100%" height="100%" styleName="black">
      <Plugin id="kalturaMix" width="0%" height="0%" includeInLayout="false" loadingPolicy="onDemand"/>
      <Plugin id="statistics" width="0%" height="0%" includeInLayout="false"/>
      
      <Plugin id="nielsenCombined" 
      	clientId="us-502202" 
      	vcid="c15"
      	tag_title="{mediaProxy.entry.name}"
      	tag_category="{mediaProxy.entry.categories}"
      	tag_subcategory="{mediaProxy.entryMetadata.subcategories}"
      	tag_censuscategory="{mediaProxy.entry.censuscategories}"
      	tag_imgurl="{mediaProxy.entry.thumbnailUrl}"
      />
      
      <Canvas id="PlayerHolder" height="100%" width="100%" styleName="black">
        <Video id="video" width="100%" height="100%"/>
        <VBox id="offlineMessageHolder" verticalAlign="middle" horizontalAlign="center" includeInLayout="false" width="100%" height="100%">
          <Spacer height="100%"/>
          <Spacer height="100%"/>
          <Label id="offlineMessage" styleName="offlineMessage" text="{mediaProxy.entry.offlineMessage}" visible="{mediaProxy.isOffline}" width="100%" height="30"/>
          <Spacer height="100%"/>
        </VBox>
        <Screens id="screensLayer" width="100%" height="100%" mouseOverTarget="{PlayerHolder}" styleName="clickThrough" startScreenId="startScreen" startScreenOverId="startScreen" pauseScreenOverId="pauseScreen" pauseScreenId="pauseScreen" playScreenOverId="playScreen" endScreenId="endScreen" endScreenOverId="endScreen"/>
        <Watermark id="watermark" width="100%" height="100%" watermarkPath="http://www.kaltura.com/content/uiconf/kaltura/kmc/appstudio/kdp3/exampleWatermark.png" watermarkClickPath="http://www.kaltura.com/" watermarkPosition="bottomLeft" padding="5"/>
        <VBox id="skipBtnHolder" width="100%" height="100%">
          <Spacer height="100%"/>
          <HBox width="100%" height="30">
            <Spacer width="100%"/>
          </HBox>
        </VBox>
        <Plugin id="gigya" width="100%" height="100%" loadingPolicy="noWait" title="{mediaProxy.entry.name}" shareEmailBody="Hi,&lt;br>I watched this video and thought you'd enjoy it too. &lt;br>$URL$ to watch.&lt;br> $sender$" shareEmailSubject="Take a look at this video"/>
        <VBox id="generalPluginContainer" width="100%" height="100%">
          <Spacer id="contentPusher" height="100%"/>
        </VBox>
      </Canvas>
      <Canvas id="controlsHolder" width="100%" height="30">
        <HBox id="ControllerScreenHolder" width="100%" height="30" verticalAlign="middle" styleName="darkBg">
          <HBox id="ControllerScreen" width="100%" height="30" horizontalGap="9" paddingLeft="9" verticalAlign="middle" styleName="darkBg">
            <Button id="playBtnControllerScreen" command="play" buttonType="iconButton" focusRectPadding="0" icon="playIcon" overIcon="playIcon" downIcon="playIcon" disabeledIcon="playIcon" selectedUpIcon="pauseIcon" selectedOverIcon="pauseIcon" selectedDownIcon="pauseIcon" selectedDisabledIcon="pauseIcon" tooltip="" upTooltip="Play" selectedTooltip="Pause" k_buttonType="buttonIconControllerArea" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
            <Button id="liveToggleStatus" toggle="true" color1="0xFF0000" color2="0xFF0000" upIcon="onAirIcon" overIcon="onAirIcon" downIcon="onAirIcon" disabeledIcon="onAirIcon" selectedUpIcon="offlineIcon" selectedOverIcon="offlineIcon" selectedDownIcon="offlineIcon" selectedDisabledIcon="offlineIcon" isSelected="{mediaProxy.isOffline}" visible="{mediaProxy.isLive}" includeInLayout="{mediaProxy.isLive}" mouseEnable="false" useHandCursor=""/>
            <VBox id="scrubberContainer" width="100%" height="30" verticalAlign="middle" verticalGap="-3" notVisible="{mediaProxy.isLive}">
              <Spacer height="10"/>
              <Scrubber id="scrubber" width="100%" height="10" styleName="" color1="14540253" color2="14540253"/>
              <HBox width="100%">
                <Timer id="timerControllerScreen1" width="40" styleName="timerProgressLeft" format="mm:ss" height="12" dynamicColor="true" timerType="forwards" color1="14540253"/>
                <Spacer width="100%" height="8"/>
                <Timer id="timerControllerScreen2" width="40" styleName="timerProgressRight" format="mm:ss" height="12" timerType="total" dynamicColor="true" color1="14540253"/>
              </HBox>
            </VBox>
            <VolumeBar id="volumeBar" styleName="volumeBtn" buttonWidth="20" width="20" height="20" buttonType="iconButton" tooltip="Change volume" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
            <Button id="shareBtnControllerScreen" buttonType="iconButton" kClick="sendNotification('doGigya')" height="22" styleName="controllerScreen" focusRectPadding="0" icon="shareIcon" tooltip="share with friends" k_buttonType="buttonIconControllerArea" uiconfId="" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
            <Button id="fullScreenBtnControllerScreen" command="fullScreen" buttonType="iconButton" height="22" styleName="controllerScreen" icon="openFullScreenIcon" selectedUpIcon="closeFullScreenIcong" selectedOverIcon="closeFullScreenIcon" selectedDownIcon="closeFullScreenIcon" selectedDisabledIcon="closeFullScreenIcon" focusRectPadding="0" allowDisable="false" tooltip="Toggle fullscreen" k_buttonType="buttonIconControllerArea" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
          </HBox>
          <Spacer width="13"/>
          <Button id="kalturaLogo" height="50" width="100" kClick="navigate('http://www.kaltura.com')" styleName="controllerScreen" icon="kalturaLogo"/>
          <Spacer width="13"/>
        </HBox>
      </Canvas>
    </VBox>
  </HBox>
  <screens>
    <screen id="startScreen">
      <VBox id="startContainer" width="100%" height="100%" verticalAlign="middle" horizontalAlign="center">
        <Spacer width="100%"/>
        <Tile id="startTile" width="100%" verticalGap="10" verticalAlign="middle" horizontalAlign="center">
          <Button id="onVideoPlayBtnStartScreen" command="play" buttonType="onScreenButton" minWidth="60" labelPlacement="top" label="Play" styleName="onScreenBtn" upIcon="playIcon" overIcon="playIcon" downIcon="playIcon" disabeledIcon="playIcon" selectedUpIcon="playIcon" selectedOverIcon="playIcon" selectedDownIcon="playIcon" selectedDisabledIcon="playIcon" k_buttonType="buttonIconControllerArea" tooltip="Play video" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
          <Button id="shareBtnStartScreen" kClick="sendNotification('doGigya')" buttonType="onScreenButton" minWidth="60" labelPlacement="top" label="Share" styleName="onScreenBtn" upIcon="shareIcon" k_buttonType="buttonIconControllerArea" tooltip="share with friends" uiconfId="" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
        </Tile>
        <Spacer width="100%"/>
      </VBox>
    </screen>
    <screen id="pauseScreen">
      <VBox id="pauseContainer" width="100%" height="100%" verticalAlign="middle" horizontalAlign="center">
        <Spacer height="100%"/>
        <Tile id="pauseTile" width="100%" verticalGap="10" verticalAlign="middle" horizontalAlign="center">
          <Button id="onVideoPlayBtnPauseScreen" command="play" buttonType="onScreenButton" minWidth="60" labelPlacement="top" label="Play" styleName="onScreenBtn" upIcon="playIcon" overIcon="playIcon" downIcon="playIcon" disabeledIcon="playIcon" selectedUpIcon="playIcon" selectedOverIcon="playIcon" selectedDownIcon="playIcon" selectedDisabledIcon="playIcon" k_buttonType="buttonIconControllerArea" tooltip="Play video" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
          <Button id="shareBtnPauseScreen" kClick="sendNotification('doGigya')" buttonType="onScreenButton" minWidth="60" labelPlacement="top" label="Share" styleName="onScreenBtn" upIcon="shareIcon" k_buttonType="buttonIconControllerArea" tooltip="share with friends" uiconfId="" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
        </Tile>
        <Spacer height="100%"/>
      </VBox>
    </screen>
    <screen id="playScreen">
      <VBox id="playContainer" width="100%" height="100%" verticalAlign="middle" horizontalAlign="center">
        <Spacer height="100%"/>
        <Tile id="playTile" width="100%" verticalGap="10" verticalAlign="middle" horizontalAlign="center"/>
        <Spacer height="100%"/>
      </VBox>
    </screen>
    <screen id="endScreen">
      <VBox id="endContainer" width="100%" height="100%" verticalAlign="middle" horizontalAlign="center">
        <Spacer height="100%"/>
        <Tile id="endTile" width="100%" verticalGap="10" verticalAlign="middle" horizontalAlign="center">
          <Button id="replayBtnEndScreen" kClick="sendNotification('doPlay')" buttonType="onScreenButton" minWidth="60" labelPlacement="top" label="Replay" styleName="onScreenBtn" upIcon="replayIcon" k_buttonType="buttonIconControllerArea" tooltip="Replay" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
          <Button id="shareBtnEndScreen" kClick="sendNotification('doGigya')" buttonType="onScreenButton" minWidth="60" labelPlacement="top" label="Share" styleName="onScreenBtn" upIcon="shareIcon" k_buttonType="buttonIconControllerArea" tooltip="share with friends" uiconfId="" color1="14540253" color2="16777215" color3="3355443" color4="10066329" color5="16777215" font="Arial"/>
        </Tile>
        <Spacer height="100%"/>
      </VBox>
    </screen>
  </screens>
  <strings>
    <string key="ENTRY_CONVERTING" value="Entry is processing, please try again in a few minutes."/>
  </strings>
  <extraData>
    <GigyaUI theme="dark">
      <config>
        <display showEmail="true" useTransitions="true" showBookmark="false" codeBoxHeight="auto" showCodeBox="true" showCloseButton="true" networksWithCodeBox="" networksToHide="livespaces, piczo, orkut, pageflakes, vox, tagged, hi5, multiply" networksToShow="facebook, twitter, wordpress" bookmarksToShow="googlebookmarks,delicious,digg,facebookshare,newsvine,reddit,twitter,ask,myaol,slashdot,skimbit,simpy,blogmarks,spurl,linkagogo,Magnolia,faves,segnalo,netvouz,blinklist,dropjack,feedmelinks"/>
        <body>
          <background frame-color="#BFBFBF" background-color="#292929" frame-thickness="0" gradient-color-begin="#292929" gradient-color-end="#292929" corner-roundness="0;0;0;0"/>
          <controls corner-roundness="4;4;4;4" gradient-color-begin="#EAEAEA" gradient-color-end="#F4F4F4" bold="false">
            <snbuttons type="textUnder" frame-color="#666666" background-color="#292929" over-frame-color="#FFFFFF" color="#BFBFBF" gradient-color-begin="#666666" gradient-color-end="Transparent" size="10" bold="false" down-frame-color="#666666" down-gradient-color-begin="Transparent" over-gradient-color-end="#ffffff" down-gradient-color-end="#666666" over-color="#ffffff" down-color="#ffffff" over-bold="false">
              <more frame-color="#A4DBFF" over-frame-color="#A4DBFF" gradient-color-begin="#F4F4F4" gradient-color-end="#BBE4FF" over-gradient-color-begin="#A4DBFF" over-gradient-color-end="#F4F4F4"/>
              <previous frame-color="#BBE4FF" over-frame-color="#A4DBFF" gradient-color-begin="#FFFFFF" gradient-color-end="#A4DBFF" over-gradient-color-begin="#A4DBFF" over-gradient-color-end="#F4F4F4"/>
            </snbuttons>
            <textboxes frame-color="#CACACA" background-color="#292929" color="#757575" gradient-color-begin="#292929" gradient-color-end="#292929" bold="false">
              <codeboxes color="#808080" frame-color="#6A6A6A" background-color="#606060" gradient-color-begin="Transparent" gradient-color-end="Transparent" size="10"/>
              <inputs frame-color="#6a6a6a" color="#808080" gradient-color-begin="Transparent" gradient-color-end="Transparent"/>
              <dropdowns list-item-over-color="#52A4DA" frame-color="#6a6a6a" background-color="#292929" color="#808080" gradient-color-begin="#292929" gradient-color-end="#292929"/>
            </textboxes>
            <buttons frame-color="#6a6a6a" background-color="Transparent" gradient-color-begin="#666666" gradient-color-end="Transparent" color="#FFFFFF" frame-thickness="1" size="12" bold="false" over-frame-color="#FFFFFF" down-frame-color="#6a6a6a" over-gradient-color-begin="#666666" down-gradient-color-begin="Transparent" over-gradient-color-end="#353535" down-gradient-color-end="Transparent" over-size="12" over-bold="false">
              <post-buttons frame-color="#6a6a6a" gradient-color-end="Transparent"/>
            </buttons>
            <listboxes frame-color="#CACACA" corner-roundness="4;4;4;4" gradient-color-begin="#F4F4F4" gradient-color-end="#FFFFFF"/>
            <checkboxes checkmark-color="#FFFFC8" frame-color="#6a6a6a" down-gradient-color-begin="#292929" down-gradient-color-end="#292929" background-color="#292929" corner-roundness="3;3;3;3" gradient-color-begin="Transparent" gradient-color-end="Transparent" over-background-color="#292929" down-background-color="#292929"/>
            <servicemarker gradient-color-begin="Transparent" gradient-color-end="#666666"/>
            <tooltips frame-thickness="0" color="#292929" gradient-color-begin="#FFFFFF" gradient-color-end="#FFFFC8" size="10" frame-color="#FFDBA4"/>
          </controls>
          <texts color="808080">
            <privacy color="#808080"/>
            <headers color="#FFFFFF" bold="false"/>
            <labels color="#FFFFFF" bold="false"/>
            <messages color="#202020" background-color="#FFFFA4" frame-thickness="0" corner-roundness="4;4;4;4"/>
            <links color="#FFFFFF" underline="false" over-color="#666666" down-color="#666666" down-bold="false"/>
          </texts>
        </body>
      </config>
    </GigyaUI>
  </extraData>
  <plugins/>
  <uiVars>
    <var key="video.keepAspectRatio" value="true"/>
    <var key="playlistAPI.autoContinue" value="false"/>
    <var key="imageDefaultDuration" value="2"/>
    <var key="autoPlay" value="false"/>
    <var key="autoMute" value="false"/>
  </uiVars>
</layout>

 -->


</body>
</html>