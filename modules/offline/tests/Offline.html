<!DOCTYPE HTML>
<html>
  <head>
    <title>Local Media</title>
    <script type="text/javascript" src="../../../tests/qunit/qunit-bootstrap.js"></script>
    <script type="text/javascript" src="../../../mwEmbedLoader.php"></script>
    <script type="text/javascript" src="../../../docs/js/doc-bootstrap.js"></script>

    <!-- qunit-kaltura must come after qunit-bootstrap.js and after mwEmbedLoader.php and after any jsCallbackReady stuff-->
    <script type="text/javascript" src="../../KalturaSupport/tests/resources/qunit-kaltura-bootstrap.js"></script>
  </head>

  <body>
    <h2>Local Media download and playback DRM content</h2>
    <div id="kaltura_player" style="width:560px;height:395px;"></div>
    <button id="download" disabled>Download</button>
    <button id="delete" disabled>Delete</button>
    <br/>
    <textarea id="textarea" style="width:560px;height:200px;white-space:nowrap;" readonly></textarea>
    <script>
      mw.setConfig('Kaltura.UdrmServerURL', 'https://udrm.kaltura.com/');
      kWidget.embed({
        "targetId": "kaltura_player",
        "entry_id": "0_caq7yan7",
        "wid": "_1788671",
        "uiconf_id": 30484161,
        "flashvars": {
          "offline": {
            "plugin": true,
            "templatePath": "resources/tmpl/offline.tmpl.html"
          },
          "streamerType": "auto"
        },
        "readyCallback": function (playerId) {
          var kdp = document.getElementById(playerId);
          var textArea = document.getElementById('textarea');
          var downloadBtn = document.getElementById('download');
          var deleteBtn = document.getElementById('delete');

          downloadBtn.addEventListener('click', function () {
            kdp.sendNotification('startDownload');
          });

          deleteBtn.addEventListener('click', function () {
            kdp.sendNotification('deleteLocalEntry', '0_caq7yan7');
          });

          kdp.kBind('playerReady', function () {
            deleteBtn.disabled = false;
          });

          kdp.kBind('offline', function (event) {
            var data = event.data;

            if (event.type === 'readyToDownload' && downloadBtn.disabled) {
              downloadBtn.disabled = false;
            }

            textarea.value += event.type + (data ? (': ' + JSON.stringify(data)) : '') + '\n';
          });
        }
      });
    </script>
  </body>
</html>